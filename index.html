<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Buurtproducten</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
  margin: 0;
  background: #f6f8f9;
  color: #2d3748;
}


/* HEADER */
header {
  background: linear-gradient(135deg, #2f855a, #276749);
  color: white;
  padding: 18px 20px;
  text-align: center;

  position: sticky;
  top: 0;
  z-index: 1000;

  backdrop-filter: blur(6px);
}
/* CONTAINER */
.container {
  max-width: 1400px;
  margin: 30px auto;
  padding: 0 24px;

  display: grid;
  grid-template-columns: 420px 1fr;
  gap: 28px;
  align-items: start;
}

/* VERKOPER KAARTEN */
.verkoper {
  background: white;
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 18px;
  border: 1px solid #e5e7eb;
  box-shadow: 0 10px 25px rgba(0,0,0,0.06);
  transition: all 0.25s ease;
  position: relative;
  overflow: hidden;
}

.verkoper::before {
  content: "";
  position: absolute;
  left: 0;
  top: 0;
  width: 5px;
  height: 100%;
  background: linear-gradient(#38a169, #2f855a);
  opacity: 0;
  transition: 0.25s;
}

.verkoper:hover::before {
  opacity: 1;
}

.verkoper:hover {
  transform: translateY(-6px) scale(1.02);
  box-shadow: 0 22px 45px rgba(0,0,0,0.15);
  border-color: #2f855a;
}

.verkoper h3 {
  margin: 0 0 8px 0;
  font-size: 20px;
}

.verkoper p {
  margin: 4px 0;
  color: #4a5568;
}

input, select, textarea {
  border-radius: 8px;
  border: 1px solid #d1d5db;
  padding: 10px;
}

input:focus, select:focus, textarea:focus {
  outline: none;
  border-color: #2f855a;
  box-shadow: 0 0 0 2px rgba(47,133,90,0.15);
}

button {
  border-radius: 8px;
  font-weight: 600;
  padding: 12px 18px;
  background: #2f855a;
  color: white;
  border: none;
  cursor: pointer;
}

button:hover {
  opacity: 0.9;
}

#map {
  height: 480px;
  border-radius: 14px;
  overflow: hidden;
  box-shadow: 0 8px 22px rgba(0,0,0,0.08);
  border: 1px solid #e5e7eb;
}

/* ===== VERKOPERS ANIMATIE ===== */
.verkoper {
  opacity: 0;
  transform: translateY(12px);
  animation: fadeInUp 0.4s ease forwards;
}

@keyframes fadeInUp {
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.hero {
  background: linear-gradient(rgba(0,0,0,0.35), rgba(0,0,0,0.35)),
              url("https://images.unsplash.com/photo-1501004318641-b39e6451bec6");
  background-size: cover;
  background-position: center;
  padding: 110px 20px;
  text-align: center;
  color: white;
}

.hero-content {
  max-width: 700px;
  margin: auto;
}

.hero h2 {
  font-size: 42px;
  margin-bottom: 12px;
}

.hero p {
  font-size: 18px;
  margin-bottom: 25px;
  opacity: 0.95;
}

/* LINKER KOLOM */
.container section:nth-child(1),
.container section:nth-child(3) {
  grid-column: 1;
}

/* RECHTER KOLOM (KAART) */
.container section:nth-child(2) {
  grid-column: 2;
  position: sticky;
  top: 20px;
}

.verkoper:hover {
transform: translateY(-12px) scale(1.03) !important;
  box-shadow: 0 25px 50px rgba(0,0,0,0.18) !important;
}

</style>
</head>

<body>

<header>
  <h1>Buurtproducten</h1>
  <p>Vind zelfgemaakte en natuurlijke producten bij jou in de buurt</p>
 <button id="toggleKnop" onclick="toggleFormulier()">
    + Nieuwe verkoper aanmelden
  </button>




</header>

<section class="hero">
  <div class="hero-content">
    <h2>Ontdek lokale makers bij jou in de buurt</h2>
    <p>Eerlijke producten rechtstreeks van de producent.</p>
    <button onclick="document.getElementById('map').scrollIntoView({behavior:'smooth'})">
      Bekijk aanbieders
    </button>
  </div>
</section>

<main class="container">

<section>
  <h2>Zoek aanbieders</h2>
  <input
    type="text"
    id="zoekPostcode"
    placeholder="Postcode (bijv. 12)"
    onkeyup="filterVerkopers()"
  >

  <select id="zoekCategorie" onchange="filterVerkopers()">
    <option value="">Alle categorie√´n</option>
    <option value="kefir">Kefir</option>
    <option value="rauwe melk">Rauwe melk</option>
    <option value="honing">Honing</option>
    <option value="overig">Overig</option>
  </select>
</section>

<section>
  <h2>Kaart met aanbieders</h2>
  <div id="map"></div>
</section>

<section>
  <h2>Aanbieders</h2>
  <div id="verkopersLijst"></div>
</section>


</main>

<!-- Scripts -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCHTiXZ7JKjoo17_ntxf0UbYKOcc8QS5nw",
  authDomain: "lokale-makers.firebaseapp.com",
  projectId: "lokale-makers",
  storageBucket: "lokale-makers.appspot.com",
  messagingSenderId: "226335679654",
  appId: "1:226335679654:web:cae8f57f497c8e01364067"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const verkopers = [];
let map;
let actieveMarker = null;
let userLat = null;
let userLon = null;


window.addEventListener("load", () => {

  // kaart starten
  map = L.map("map").setView([52.1, 5.1], 7);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "¬© OpenStreetMap"
  }).addTo(map);

  // locatie ophalen
  if (navigator.geolocation) {

    navigator.geolocation.getCurrentPosition(

      pos => {

        userLat = pos.coords.latitude;
        userLon = pos.coords.longitude;

        map.setView([userLat, userLon], 11);

        L.circleMarker([userLat, userLon], {
          radius: 8,
          color: "#2563eb",
          fillColor: "#3b82f6",
          fillOpacity: 1
        })
        .addTo(map)
        .bindPopup("üìç Jij bent hier");

        laadVerkopers();
      },

      err => {
        console.log("LOCATIE FOUT:", err.message);
        laadVerkopers();
      }

    );

  } else {
    laadVerkopers();
  }

});
// =============================
// VERKOPERS LADEN
// =============================
function laadVerkopers() {

  db.collection("verkopers")
    .where("goedgekeurd", "==", true)
    .get()
    .then(snapshot => {

      verkopers.length = 0;

      snapshot.forEach(doc => {
const v = doc.data();

// afstand berekenen als locatie bekend is
if(userLat && userLon){
  const dx = userLat - parseFloat(v.lat);
  const dy = userLon - parseFloat(v.lon);
  v.afstand = Math.sqrt(dx*dx + dy*dy);
}

verkopers.push(v);

        const lat = parseFloat(v.lat) + (Math.random()-0.5)*0.02;
        const lon = parseFloat(v.lon) + (Math.random()-0.5)*0.02;

        const marker = L.marker([lat, lon], { riseOnHover:true })
          .addTo(map)
          .bindPopup(`<strong>${v.naam}</strong><br>${v.producten}`);

        v.marker = marker;

marker.on("click", () => {
  highlightVerkoper(v);
  openDetail(v);
});
      });

      toonVerkopers();
    });
}


// =============================
// LIJST TONEN
// =============================
function toonVerkopers() {

  const lijst = document.getElementById("verkopersLijst");
  lijst.innerHTML = "";
// sorteer op afstand als locatie bekend is
if(userLat && userLon){

  verkopers.forEach(v => {
    const dx = userLat - parseFloat(v.lat);
    const dy = userLon - parseFloat(v.lon);
    v.afstand = Math.sqrt(dx*dx + dy*dy);
  });
}

  verkopers.sort((a,b)=> (a.afstand ?? 999999) - (b.afstand ?? 999999));


  verkopers.forEach(v => {

    const div = document.createElement("div");
    div.className = "verkoper";
    div.style.cursor = "pointer";

div.innerHTML = `
  <h3>${v.naam}</h3>
  <p>${v.producten}</p>
  ${v.afstand ? `<p style="color:#2f855a;font-weight:600;">üìç ${Math.round(v.afstand*111)} km bij jou vandaan</p>` : ""}
  ${v.telefoon ? `<p><strong>Telefoon:</strong> ${v.telefoon}</p>` : ""}
`;



div.onclick = () => {
  openDetail(v);
};

    v.element = div;
    setTimeout(() => {
  lijst.appendChild(div);
}, 60);
  });
}


// =============================
// HIGHLIGHT
// =============================
function highlightVerkoper(v){

  document.querySelectorAll(".verkoper").forEach(el=>{
    el.style.background="white";
    el.style.border="1px solid #ddd";
    el.style.transform="scale(1)";
  });

  if(v.element){
    v.element.style.background="#e6f4ea";
    v.element.style.border="2px solid #2f855a";
    v.element.style.transform="scale(1.01)";
  }

  if(actieveMarker){
    actieveMarker.setZIndexOffset(0);
  }

  v.marker.setZIndexOffset(1000);
  actieveMarker = v.marker;

if(v.element){
  v.element.scrollIntoView({
    behavior: "smooth",
    block: "center"
  });
}

}


// =============================
// FILTER
// =============================
function filterVerkopers(){

  const p = document.getElementById("zoekPostcode").value;
  const c = document.getElementById("zoekCategorie").value;

  verkopers.forEach(v=>{

    const ok =
      (p==="" || v.postcode.startsWith(p)) &&
      (c==="" || v.categorie===c);

    v.element.style.display = ok ? "block":"none";

    if(v.marker){
      ok ? v.marker.addTo(map) : map.removeLayer(v.marker);
    }
  });
}


// =============================
// FORMULIER
// =============================
function toggleFormulier(){
  const f = document.getElementById("aanmeldFormulier");

  const zichtbaar = window.getComputedStyle(f).display !== "none";

  if(zichtbaar){
    f.style.display = "none";
  } else {
    f.style.display = "flex";
  }
}


// =============================
// VERKOPER TOEVOEGEN
// =============================
function voegVerkoperToe(){

  const naam=document.getElementById("naam").value;
  const postcode=document.getElementById("postcode").value;
  const plaats=document.getElementById("plaats").value;
  const categorie=document.getElementById("categorie").value;
  const producten=document.getElementById("producten").value;

if(!naam||!postcode||!plaats||!categorie||!producten){
  document.getElementById("aanmeldMelding").innerText = "Vul alle velden in";
  document.getElementById("aanmeldMelding").style.display = "block";
  return;
}

  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${plaats}`)
    .then(r=>r.json())
    .then(data=>{

      if(!data[0]) return;

      return db.collection("verkopers").add({
        naam,
        postcode,
        plaats,
        categorie,
        producten,
        lat:data[0].lat,
        lon:data[0].lon,
        goedgekeurd:false,
        aangemaaktOp:new Date()
      });
    })
    .then(()=>{

      document.getElementById("aanmeldFormulier").style.display="none";
      document.getElementById("aanmeldMelding").style.display="block";

      document.getElementById("naam").value="";
      document.getElementById("postcode").value="";
      document.getElementById("plaats").value="";
      document.getElementById("producten").value="";
    });
}

function openDetail(v){

  document.getElementById("detailInhoud").innerHTML = `
    <h2>${v.naam}</h2>
    <p><strong>Categorie:</strong> ${v.categorie}</p>
    <p><strong>Plaats:</strong> ${v.plaats}</p>
    <p>${v.producten}</p>
  `;

  document.getElementById("detailPopup").style.display = "flex";
  highlightVerkoper(v);

document.getElementById("detailPopup").onclick = function(e){
  if(e.target === this){
    sluitDetail();
  }
};
}

function sluitDetail(){

  document.getElementById("detailPopup").style.display = "none";

  // highlight uitzetten
  document.querySelectorAll(".verkoper").forEach(el=>{
    el.style.background="white";
    el.style.border="1px solid #ddd";
    el.style.transform="scale(1)";
  });

  // marker resetten
  if(actieveMarker){
    actieveMarker.setZIndexOffset(0);
    actieveMarker = null;
  }
}

function toonMelding(tekst){

  let melding = document.createElement("div");

  melding.innerText = tekst;

  melding.style.position = "fixed";
  melding.style.top = "20px";
  melding.style.left = "50%";
  melding.style.transform = "translateX(-50%)";
  melding.style.background = "#2f855a";
  melding.style.color = "white";
  melding.style.padding = "12px 18px";
  melding.style.borderRadius = "8px";
  melding.style.zIndex = "10000";
  melding.style.boxShadow = "0 6px 18px rgba(0,0,0,0.2)";

  document.body.appendChild(melding);

  setTimeout(() => {
    melding.remove();
  }, 2500);
}

document.addEventListener("keydown", function(e){
  if(e.key === "Escape"){
    sluitDetail();
  }
});



</script>

<div id="aanmeldFormulier" style="
  display:none;
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0.6);
  justify-content:center;
  align-items:center;
  z-index:9998;
" onclick="toggleFormulier()">

  <!-- WITTE POPUP BLOK -->
  <div style="
    background:white;
    padding:25px;
    border-radius:12px;
    max-width:500px;
    width:90%;
    position:relative;
  " onclick="event.stopPropagation()">

    <input id="naam" placeholder="Naam / bedrijfsnaam">
    <input id="postcode" placeholder="Postcode (bijv. 1234)">
    <input id="plaats" placeholder="Plaats">

    <select id="categorie">
      <option value="">Kies een categorie</option>
      <option value="kefir">Kefir</option>
      <option value="rauwe melk">Rauwe melk</option>
      <option value="honing">Honing</option>
      <option value="overig">Overig</option>
    </select>

    <textarea id="producten" placeholder="Welke producten bied je aan?"></textarea>

    <button onclick="voegVerkoperToe()">Verzenden</button>

    <p id="aanmeldMelding" style="display:none; color:#2f855a;">
      Dank je voor je aanmelding. We controleren deze eerst.
    </p>

  </div>
</div>

</body>
</html>
